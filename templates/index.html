<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div id="banner"></div>
    <label for="server-select">Choisissez un serveur :</label>
    <select id="server-select">
        <option value="Tiliwan1">Tiliwan1</option>
        <option value="Tiliwan2">Tiliwan2</option>
        <option value="Oshimo">Oshimo</option>
        <option value="Herdegrize">Herdegrize</option>
        <option value="Euro">Euro</option>
    </select>

    <div class="vip-info">
        <div class="vip-rates">
            <span>Redistribution VIP pour <span id="current-server-name">Tiliwan1</span> :</span>
            <span>VIP 1 : <span id="vip1-share">0</span> jetons</span>
            <span>VIP 2 : <span id="vip2-share">0</span> jetons</span>
            <span>VIP 3 : <span id="vip3-share">0</span> jetons</span>
            <span>Commission totale : <span id="total-commission">0</span> jetons</span>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Nom d'utilisateur</th>
                <th>Bénéfice (Kamas)</th>
                <th>Mises totales (Kamas)</th>
                <th>VIP</th>
            </tr>
        </thead>
        <tbody id="leaderboard-body">
            <tr>
                <td colspan="5">Chargement...</td>
            </tr>
        </tbody>
    </table>

    <div class="vip-redistribution">
        <h2>Redistribution VIP</h2>
        <p><strong>VIP 1 :</strong> 20% des gains redistribués</p>
        <p><strong>VIP 2 :</strong> 30% des gains redistribués</p>
        <p><strong>VIP 3 :</strong> 50% des gains redistribués</p>
    </div>

    <script>
        let currentServer = 'Tiliwan1'; // Serveur par défaut

        function formatKamas(jetons) {
            const amount = parseInt(jetons);
            const kamas = amount * 10000; // 1 jeton = 10k kamas
            const isNegative = kamas < 0;
            const absKamas = Math.abs(kamas);

            let result;
            if (absKamas >= 1000000) {
                const millions = absKamas/1000000;
                const whole = Math.floor(millions);
                const decimal = Math.floor((millions - whole) * 10);
                result = decimal === 0 ? `${whole}M Kamas` : `${whole}M${decimal} Kamas`;
            } else {
                result = `${Math.floor(absKamas/1000)}K Kamas`;
            }

            return isNegative ? `-${result}` : result;
        }

        function calculateBenefice(wins, total_bets) {
            const win_amount = parseInt(wins);
            const bet_amount = parseInt(total_bets);
            return `${win_amount - bet_amount} jetons`;
        }

        function getHighestVip(userId, server) {
            // Vérifie d'abord si l'utilisateur est dans la liste des interdits
            return fetch('/api/check_forbidden?user_id=' + userId)
                .then(response => response.json())
                .then(data => {
                    if (data.forbidden) {
                        return '---';
                    }
                    // Si non interdit, récupère le statut VIP
                    return fetch(`/api/vip_status?user_id=${userId}&server=${server}`)
                        .then(response => response.text());
                })
                .catch(() => '---');
        }

        function fetchLeaderboardData() {
            // Appeler l'API Flask pour obtenir les données du leaderboard
            fetch(`/api/leaderboard?server=${currentServer}&t=${new Date().getTime()}`)
                .then(response => response.json())
                .then(data => {
                    updateLeaderboardTable(data); // Mettre à jour la table avec les données reçues
                })
                .catch(error => {
                    console.error("Erreur lors de la récupération des données :", error);
                });
        }

        function updateLeaderboardTable(data) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = ''; // Effacer les données existantes

            if (data && data.utilisateurs) {
                const promises = Object.entries(data.utilisateurs).map(([userId, user]) => {
                    return getHighestVip(userId, currentServer).then(vipStatus => {
                        return `
                            <tr>
                                <td>${user.username}</td>
                                <td>${formatKamas(calculateBenefice(user.total_wins, user.total_bets))}</td>
                                <td>${formatKamas(user.total_bets)}</td>
                                <td>${vipStatus}</td>
                            </tr>
                        `;
                    });
                });

                Promise.all(promises).then(rows => {
                    tbody.innerHTML = rows.join('');
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="5">Aucune donnée disponible</td></tr>`;
            }
        }

        // Mettre à jour uniquement si l'onglet est actif, toutes les 30 secondes
        let updateInterval;

        function startUpdates() {
            updateInterval = setInterval(() => {
                if (!document.hidden) {
                    fetch(`/api/leaderboard?server=${currentServer}&t=${new Date().getTime()}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.utilisateurs) {
                                updateLeaderboardTable(data);
                            }
                        })
                        .catch(error => {
                            console.error("Erreur lors de la mise à jour :", error);
                        });
                }
            }, 30000);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(updateInterval);
            } else {
                startUpdates();
            }
        });

        startUpdates();

        // Initialisation : Charger les données dès le chargement de la page
        window.onload = fetchLeaderboardData;

        // Gestion du menu déroulant pour changer de serveur
        document.getElementById('server-select').addEventListener('change', function() {
            currentServer = this.value; // Changer le serveur courant
            fetchLeaderboardData(); // Charger les nouvelles données
        });
    </script>
</body>
</html>