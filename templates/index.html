<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div id="banner"></div>
    <div class="vip-info">
        <div class="vip-rates">
            <h2>Redistribution VIP - <span id="current-server-name">Tiliwan1</span></h2>
            <div class="vip-grid">
                <div class="vip-item">
                    <span class="vip-label">VIP 1 (20%)</span>
                    <span class="vip-value" id="vip1-share">0 jetons</span>
                </div>
                <div class="vip-item">
                    <span class="vip-label">VIP 2 (30%)</span>
                    <span class="vip-value" id="vip2-share">0 jetons</span>
                </div>
                <div class="vip-item">
                    <span class="vip-label">VIP 3 (50%)</span>
                    <span class="vip-value" id="vip3-share">0 jetons</span>
                </div>
                <div class="vip-total">
                    <span class="vip-label">Total redistribué</span>
                    <span class="vip-value" id="total-commission">0 jetons</span>
                </div>
            </div>
        </div>
    </div>

    <label for="server-select">Choisissez un serveur :</label>
    <select id="server-select">
        <option value="Tiliwan1">Tiliwan1</option>
        <option value="Tiliwan2">Tiliwan2</option>
        <option value="Oshimo">Oshimo</option>
        <option value="Herdegrize">Herdegrize</option>
        <option value="Euro">Euro</option>
    </select>

    <table>
        <thead>
            <tr>
                <th>Nom d'utilisateur</th>
                <th>Bénéfice (Kamas)</th>
                <th>Mises totales (Kamas)</th>
                <th>VIP</th>
            </tr>
        </thead>
        <tbody id="leaderboard-body">
            <tr>
                <td colspan="5">Chargement...</td>
            </tr>
        </tbody>
    </table>

    <script>
        let currentServer = 'Tiliwan1'; // Serveur par défaut

        function formatKamas(jetons) {
            const amount = parseInt(jetons);
            const kamas = amount * 10000; // 1 jeton = 10k kamas
            const isNegative = kamas < 0;
            const absKamas = Math.abs(kamas);

            let result;
            if (absKamas >= 1000000) {
                const millions = absKamas/1000000;
                const whole = Math.floor(millions);
                const decimal = Math.floor((millions - whole) * 10);
                result = decimal === 0 ? `${whole}M Kamas` : `${whole}M${decimal} Kamas`;
            } else {
                result = `${Math.floor(absKamas/1000)}K Kamas`;
            }

            return isNegative ? `-${result}` : result;
        }

        function calculateBenefice(wins, total_bets) {
            const win_amount = parseInt(wins);
            const bet_amount = parseInt(total_bets);
            return `${win_amount - bet_amount} jetons`;
        }

        function getHighestVip(userId, server) {
            // Vérifie d'abord si l'utilisateur est dans la liste des interdits
            return fetch('/api/check_forbidden?user_id=' + userId)
                .then(response => response.json())
                .then(data => {
                    if (data.is_forbidden) {
                        return 'Utilisateur interdit';
                    }
                    // Si non interdit, récupère le statut VIP
                    return fetch(`/api/vip_status?user_id=${userId}&server=${server}`)
                        .then(response => response.json()) // Parse le JSON
                        .then(data => {
                            if (data.vip_level) {
                                return `VIP ${data.vip_level}`;
                            }
                            return '---';
                        });
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des données :', error);
                    return '---.';
                });
        }


        function fetchLeaderboardData() {
            // Appeler l'API Flask pour obtenir les données du leaderboard
            fetch(`/api/leaderboard?server=${currentServer}&t=${new Date().getTime()}`)
                .then(response => response.json())
                .then(data => {
                    updateLeaderboardTable(data); // Mettre à jour la table avec les données reçues
                    if (data && data.totalCommission) {
                        updateVIPValues(data.totalCommission);
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la récupération des données :", error);
                });
        }

        function updateLeaderboardTable(data) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = ''; // Effacer les données existantes

            if (data && data.utilisateurs) {
                const promises = Object.entries(data.utilisateurs).map(([userId, user]) => {
                    return getHighestVip(userId, currentServer).then(vipStatus => {
                        return `
                            <tr>
                                <td>${user.username}</td>
                                <td>${formatKamas(calculateBenefice(user.total_wins, user.total_bets))}</td>
                                <td>${formatKamas(user.total_bets)}</td>
                                <td>${vipStatus}</td>
                            </tr>
                        `;
                    });
                });

                Promise.all(promises).then(rows => {
                    tbody.innerHTML = rows.join('');
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="5">Aucune donnée disponible</td></tr>`;
            }
        }

        // Mettre à jour uniquement si l'onglet est actif, toutes les 30 secondes
        let updateInterval;

        function startUpdates() {
            updateInterval = setInterval(() => {
                if (!document.hidden) {
                    fetch(`/api/leaderboard?server=${currentServer}&t=${new Date().getTime()}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.utilisateurs) {
                                updateLeaderboardTable(data);
                                if (data && data.totalCommission) {
                                    updateVIPValues(data.totalCommission);
                                }
                            }
                        })
                        .catch(error => {
                            console.error("Erreur lors de la mise à jour :", error);
                        });
                }
            }, 30000);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(updateInterval);
            } else {
                startUpdates();
            }
        });

        startUpdates();

        // Initialisation : Charger les données dès le chargement de la page
        window.onload = fetchLeaderboardData;

        // Gestion du menu déroulant pour changer de serveur
        document.getElementById('server-select').addEventListener('change', function() {
            currentServer = this.value; // Changer le serveur courant
            fetchLeaderboardData(); // Charger les nouvelles données
        });

        function formatKamasMillions(jetons) {
            const kamas = jetons * 10000; // 1 jeton = 10k kamas
            const millions = kamas / 1000000;
            return millions >= 1 ? `${millions.toFixed(1)}M Kamas` : `${(kamas/1000).toFixed(0)}K Kamas`;
        }

        function updateVIPValues(commission) {
            const totalCommission = parseInt(commission.split(' ')[0]);

            const vip1Amount = totalCommission * 0.20;
            const vip2Amount = totalCommission * 0.30;
            const vip3Amount = totalCommission * 0.50;

            document.getElementById('vip1-share').textContent = formatKamasMillions(vip1Amount);
            document.getElementById('vip2-share').textContent = formatKamasMillions(vip2Amount);
            document.getElementById('vip3-share').textContent = formatKamasMillions(vip3Amount);
            document.getElementById('total-commission').textContent = formatKamasMillions(totalCommission);
        }
    </script>
</body>
</html>